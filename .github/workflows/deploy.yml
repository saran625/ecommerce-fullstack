name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Get GitHub Actions IP Ranges
        run: |
          echo "GitHub Actions IP ranges:"
          curl -s https://api.github.com/meta | jq -r '.actions[]'
          echo -e "\nCurrent runner IP:"
          curl -s ifconfig.me

          <<<<<<< HEAD
              location /api {
                  proxy_pass http://backend:5000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_cache_bypass $http_upgrade;
              }
          
              location /health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }
          
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
          }
          EOF
                  fi
                  
                  cp nginx.conf deployment/
          <<<<<<< HEAD
                  
                  # Create Dockerfiles if they don't exist
                  echo "üê≥ Creating Dockerfiles..."
                  
                  # Backend Dockerfile
                  cat > deployment/backend/Dockerfile << 'EOF'
          FROM python:3.11-slim
          
          WORKDIR /app
          
          COPY requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt
          
          COPY . .
          
          RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
          
          EXPOSE 5000
          
          CMD python wait_for_db.py && python app.py
          EOF
          
                  # Frontend Dockerfile
                  cat > deployment/frontend/Dockerfile << 'EOF'
          FROM node:18-alpine as build
          
          WORKDIR /app
          
          COPY package*.json ./
          RUN npm ci --only=production
          
          COPY . .
          RUN npm run build
          
          FROM nginx:alpine
          
          # Copy built frontend
          COPY --from=build /app/build /usr/share/nginx/html
          
          # Copy nginx configuration
          COPY nginx.conf /etc/nginx/conf.d/default.conf
          
          EXPOSE 80
          
          CMD ["nginx", "-g", "daemon off;"]
          EOF
          
                  # Create deployment package
                  cd deployment
                  tar -czf ../ecommerce-app.tar.gz .
                  cd ..
                  echo "‚úÖ Deployment package created: ecommerce-app.tar.gz"
                  
                  # List contents for verification
                  echo "üìÅ Package contents:"
                  tar -tzf ecommerce-app.tar.gz | head -20
              
              - name: Upload to EC2
                uses: appleboy/scp-action@v0.1.3
                with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USERNAME }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: "ecommerce-app.tar.gz"
                  target: "/home/ubuntu/"
              
          =======
                  tar -czf ecommerce-app.tar.gz deployment/
              
          >>>>>>> 86ce0af8dee8fd524e34c68148e6cf69a1b70110
               - name: Deploy via SSH
                uses: appleboy/ssh-action@v1.0.3
                with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USERNAME }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                    echo "üöÄ Starting deployment to 3.84.242.4..."
                    
                    cd /home/ubuntu
                    
                    # Stop any existing services
                    echo "üõë Stopping existing services..."
                    sudo docker-compose down || true
                    
                    # Extract and fix nginx configuration
                    echo "üì§ Extracting deployment package..."
                    tar -xzf ecommerce-app.tar.gz
                    cd deployment
                    
                    # FIX: Update nginx.conf to use localhost
                    echo "üîß Fixing nginx configuration..."
                    sed -i 's/proxy_pass http:\/\/backend:5000;/proxy_pass http:\/\/localhost:5000;/g' nginx.conf
                    
                    # FIX: Update docker-compose MongoDB connection
                    sed -i 's/MONGO_URI=mongodb:\/\/mongodb:27017\//MONGO_URI=mongodb:\/\/localhost:27017\//g' docker-compose.yml
                    
                    # Build and start services
                    echo "üê≥ Building and starting Docker containers..."
                    sudo docker-compose up --build -d
                    
                    # Wait for backend
                    echo "‚è≥ Waiting for backend to start..."
                    sleep 30
                    
                    # Setup Nginx
                    echo "üåê Setting up Nginx..."
                    sudo cp nginx.conf /etc/nginx/sites-available/ecommerce
                    sudo ln -sf /etc/nginx/sites-available/ecommerce /etc/nginx/sites-enabled/
                    sudo rm -f /etc/nginx/sites-enabled/default
                    sudo nginx -t
                    sudo systemctl restart nginx
                    
                    echo "üéâ Deployment completed! Visit: http://3.84.242.4/"
