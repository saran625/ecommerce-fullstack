name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
<<<<<<< HEAD
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          echo "ðŸ“¦ Creating deployment package..."
=======
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create deployment package
      run: |
        echo "ðŸ“¦ Creating deployment package..."
        
        # Create deployment directory
        mkdir -p deployment
        cp -r backend deployment/
        cp -r frontend deployment/
        cp docker-compose.yml deployment/
        cp nginx.conf deployment/
        
        # Fix configuration files for production
        echo "ðŸ”§ Fixing configuration for production..."
        
        # Fix nginx.conf - use localhost instead of backend
        sed -i 's/proxy_pass http:\/\/backend:5000;/proxy_pass http:\/\/localhost:5000;/g' deployment/nginx.conf
        
        # Fix docker-compose.yml - use localhost for MongoDB
        sed -i 's/MONGO_URI=mongodb:\/\/mongodb:27017\//MONGO_URI=mongodb:\/\/localhost:27017\//g' deployment/docker-compose.yml
        
        # Create frontend environment file with correct IP
        echo "REACT_APP_API_URL=http://3.84.242.4/api" > deployment/frontend/.env
        
        # Create Backend Dockerfile
        cat > deployment/backend/Dockerfile << 'DOCKERFILE_EOF'
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

EXPOSE 5000

CMD python wait_for_db.py && python app.py
DOCKERFILE_EOF

        # Create Frontend Dockerfile
        cat > deployment/frontend/Dockerfile << 'DOCKERFILE_EOF'
FROM node:18-alpine as build

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine

# Copy built frontend
COPY --from=build /app/build /usr/share/nginx/html

# Copy nginx configuration
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
DOCKERFILE_EOF

        # Create deployment package
        cd deployment
        tar -czf ../ecommerce-app.tar.gz .
        cd ..
        echo "âœ… Deployment package created"
    
    - name: Upload to EC2
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "ecommerce-app.tar.gz"
        target: "/home/ubuntu/"
    
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ðŸš€ Starting deployment to 3.84.242.4..."
>>>>>>> 76539eb194456364694b6ba035394b88537d81da
          
          # Create deployment directory
          mkdir -p deployment
          cp -r backend deployment/
          cp -r frontend deployment/
          cp docker-compose.yml deployment/
          cp nginx.conf deployment/
          
<<<<<<< HEAD
          # Fix configuration files for production
          echo "ðŸ”§ Fixing configuration for production..."
=======
          # Stop any existing services
          echo "ðŸ›‘ Stopping existing services..."
          sudo docker-compose down || true
          sudo systemctl stop nginx apache2 2>/dev/null || true
          
          # Clean up old deployment
          sudo rm -rf deployment 2>/dev/null || true
>>>>>>> 76539eb194456364694b6ba035394b88537d81da
          
          # Fix nginx.conf - use localhost instead of backend
          sed -i 's/proxy_pass http:\/\/backend:5000;/proxy_pass http:\/\/localhost:5000;/g' deployment/nginx.conf
          
          # Fix docker-compose.yml - use localhost for MongoDB
          sed -i 's/MONGO_URI=mongodb:\/\/mongodb:27017\//MONGO_URI=mongodb:\/\/localhost:27017\//g' deployment/docker-compose.yml
          
          # Create frontend environment file with correct IP
          echo "REACT_APP_API_URL=http://3.84.242.4/api" > deployment/frontend/.env
          
          # Create Backend Dockerfile
          cat > deployment/backend/Dockerfile << 'DOCKERFILE_EOF'
          FROM python:3.11-slim
          
          WORKDIR /app
          
          COPY requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt
          
          COPY . .
          
          RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
          
          EXPOSE 5000
          
          CMD python wait_for_db.py && python app.py
          DOCKERFILE_EOF
          
          # Create Frontend Dockerfile
          cat > deployment/frontend/Dockerfile << 'DOCKERFILE_EOF'
          FROM node:18-alpine as build
          
          WORKDIR /app
          
          COPY package*.json ./
          RUN npm ci --only=production
          
          COPY . .
          RUN npm run build
          
          FROM nginx:alpine
          
          # Copy built frontend
          COPY --from=build /app/build /usr/share/nginx/html
          
          # Copy nginx configuration
          COPY nginx.conf /etc/nginx/conf.d/default.conf
          
          EXPOSE 80
          
          CMD ["nginx", "-g", "daemon off;"]
          DOCKERFILE_EOF
          
          # Create deployment package
          cd deployment
<<<<<<< HEAD
          tar -czf ../ecommerce-app.tar.gz .
          cd ..
          echo "âœ… Deployment package created"
    
      - name: Upload to EC2
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "ecommerce-app.tar.gz"
          target: "/home/ubuntu/"
    
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ðŸš€ Starting deployment to 3.84.242.4..."
            
            cd /home/ubuntu
            
            # Stop any existing services
            echo "ðŸ›‘ Stopping existing services..."
            sudo docker-compose down || true
            sudo systemctl stop nginx apache2 2>/dev/null || true
            
            # Clean up old deployment
            sudo rm -rf deployment 2>/dev/null || true
            
            # Extract deployment package
            echo "ðŸ“¤ Extracting deployment package..."
            tar -xzf ecommerce-app.tar.gz
            cd deployment
            
            # Build and start services
            echo "ðŸ³ Building and starting Docker containers..."
            sudo docker-compose up --build -d
            
            # Wait for services to start
            echo "â³ Waiting for services to initialize..."
            sleep 30
            
            # Setup Nginx for production
            echo "ðŸŒ Setting up Nginx..."
            sudo cp nginx.conf /etc/nginx/sites-available/ecommerce
            sudo ln -sf /etc/nginx/sites-available/ecommerce /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t
            sudo systemctl restart nginx
            sudo systemctl enable nginx
            
            # Check service status
            echo "ðŸ“Š Checking container status..."
            sudo docker ps
            
            # Health checks
            echo "ðŸ¥ Running health checks..."
            
            # Backend health check
            if curl -f http://localhost:5000/api/health; then
              echo "âœ… Backend is healthy"
            else
              echo "âŒ Backend health check failed"
              sudo docker logs ecommerce_backend || true
            fi
            
            # Frontend health check
            if curl -f http://localhost > /dev/null 2>&1; then
              echo "âœ… Frontend is serving"
            else
              echo "âŒ Frontend health check failed"
              sudo tail -20 /var/log/nginx/error.log || true
            fi
            
            # Check external access
            echo "ðŸŒ Testing external access..."
            if curl -f http://3.84.242.4/ > /dev/null 2>&1; then
              echo "âœ… Website is accessible at http://3.84.242.4/"
            else
              echo "âš ï¸  External access test failed"
            fi
            
            echo "ðŸŽ‰ Deployment completed! Visit: http://3.84.242.4/"
=======
          
          # Build and start services
          echo "ðŸ³ Building and starting Docker containers..."
          sudo docker-compose up --build -d
          
          # Wait for services to start
          echo "â³ Waiting for services to initialize..."
          sleep 30
          
          # Setup Nginx for production
          echo "ðŸŒ Setting up Nginx..."
          sudo cp nginx.conf /etc/nginx/sites-available/ecommerce
          sudo ln -sf /etc/nginx/sites-available/ecommerce /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          sudo nginx -t
          sudo systemctl restart nginx
          sudo systemctl enable nginx
          
          # Check service status
          echo "ðŸ“Š Checking container status..."
          sudo docker ps
          
          # Health checks
          echo "ðŸ¥ Running health checks..."
          
          # Backend health check
          if curl -f http://localhost:5000/api/health; then
            echo "âœ… Backend is healthy"
          else
            echo "âŒ Backend health check failed"
            sudo docker logs ecommerce_backend || true
          fi
          
          # Frontend health check
          if curl -f http://localhost > /dev/null 2>&1; then
            echo "âœ… Frontend is serving"
          else
            echo "âŒ Frontend health check failed"
            sudo tail -20 /var/log/nginx/error.log || true
          fi
          
          # Check external access
          echo "ðŸŒ Testing external access..."
          if curl -f http://3.84.242.4/ > /dev/null 2>&1; then
            echo "âœ… Website is accessible at http://3.84.242.4/"
          else
            echo "âš ï¸  External access test failed"
          fi
          
          echo "ðŸŽ‰ Deployment completed! Visit: http://3.84.242.4/"
>>>>>>> 76539eb194456364694b6ba035394b88537d81da
