name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Get GitHub Actions IP Ranges
        run: |
          echo "GitHub Actions IP ranges:"
          curl -s https://api.github.com/meta | jq -r '.actions[]'
          echo -e "\nCurrent runner IP:"
          curl -s ifconfig.me

<<<<<<< HEAD
    location /api {
        proxy_pass http://backend:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
EOF
        fi
        
        cp nginx.conf deployment/
<<<<<<< HEAD
        
        # Create Dockerfiles if they don't exist
        echo "ðŸ³ Creating Dockerfiles..."
        
        # Backend Dockerfile
        cat > deployment/backend/Dockerfile << 'EOF'
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

EXPOSE 5000

CMD python wait_for_db.py && python app.py
EOF

        # Frontend Dockerfile
        cat > deployment/frontend/Dockerfile << 'EOF'
FROM node:18-alpine as build

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine

# Copy built frontend
COPY --from=build /app/build /usr/share/nginx/html

# Copy nginx configuration
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
EOF

        # Create deployment package
        cd deployment
        tar -czf ../ecommerce-app.tar.gz .
        cd ..
        echo "âœ… Deployment package created: ecommerce-app.tar.gz"
        
        # List contents for verification
        echo "ðŸ“ Package contents:"
        tar -tzf ecommerce-app.tar.gz | head -20
    
    - name: Upload to EC2
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "ecommerce-app.tar.gz"
        target: "/home/ubuntu/"
    
=======
        tar -czf ecommerce-app.tar.gz deployment/
    
>>>>>>> 86ce0af8dee8fd524e34c68148e6cf69a1b70110
    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
<<<<<<< HEAD
          echo "ðŸš€ Starting deployment process..."
          
          cd /home/ubuntu
          
          # Stop any existing services
          echo "ðŸ›‘ Stopping existing services..."
          sudo docker-compose down || true
          
          # Extract deployment package
          echo "ðŸ“¤ Extracting deployment package..."
          tar -xzf ecommerce-app.tar.gz
          cd deployment
          
          # Build and start services
          echo "ðŸ³ Building and starting Docker containers..."
          sudo docker-compose up --build -d
          
          # Wait for services to start
          echo "â³ Waiting for services to initialize..."
          sleep 40
          
          # Check service status
          echo "ðŸ“Š Checking container status..."
          sudo docker ps
          
          # Health checks
          echo "ðŸ¥ Running health checks..."
          
          # Backend health check
          if curl -f http://localhost:5000/api/health; then
            echo "âœ… Backend is healthy"
          else
            echo "âŒ Backend health check failed"
          fi
          
          # Frontend health check
          if curl -f http://localhost; then
            echo "âœ… Frontend is serving"
          else
            echo "âŒ Frontend health check failed"
          fi
          
          # Check products endpoint
          echo "ðŸ“± Checking products API..."
          curl http://localhost:5000/api/products | head -c 200
          
          
          echo "ðŸŽ‰ Deployment completed successfully!"
=======
          echo "ðŸ”„ Deploying to EC2 instance in us-east-1..."
          cd /home/ubuntu
          tar -xzf ecommerce-app.tar.gz
          cd deployment
          sudo docker-compose down || true
          sudo docker-compose up --build -d
          sleep 30
          echo "âœ… Services status:"
          sudo docker ps
          echo "ðŸŽ‰ Deployment completed!"
>>>>>>> 86ce0af8dee8fd524e34c68148e6cf69a1b70110
=======
     
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -euo pipefail
      
            # change to home dir
            cd /home/ubuntu
      
            # if repo already exists, update it; otherwise shallow-clone
            if [ -d app/.git ]; then
              cd app
              git fetch --all --prune
              git reset --hard origin/main
              git clean -fdx
            else
              rm -rf app
              git clone --depth=1 https://github.com/saran625/ecommerce-fullstack.git app
              cd app
            fi
      
            # choose whether to use sudo based on docker group membership
            if id -nG "$(whoami)" | grep -qw docker; then
              DC="docker-compose"
              DOCKER="docker"
            else
              DC="sudo docker-compose"
              DOCKER="sudo docker"
            fi
      
            # Check what's using port 80
            echo "Checking services using port 80..."
            sudo netstat -tulpn | grep :80 || echo "Port 80 check completed"
      
            # Stop and remove any containers from previous deployments
            echo "Stopping and removing existing containers..."
            $DC down || true
      
            # Force remove ALL containers that might conflict
            echo "Removing any conflicting containers..."
            $DOCKER rm -f ecommerce_mongodb ecommerce_backend ecommerce_frontend app_mongodb app_backend app_frontend || true
      
            # Remove all stopped containers
            $DOCKER container prune -f
      
            # Remove unused networks
            $DOCKER network prune -f
      
            # Stop any service using port 80 (like nginx/apache)
            echo "Stopping services that might use port 80..."
            sudo systemctl stop nginx || true
            sudo systemctl stop apache2 || true
            sudo pkill -f ":80" || true
      
            # prefer pulling images (fast). If pull fails, build on host.
            if $DC pull --ignore-pull-failures; then
              $DC up -d
            else
              # fallback: build if pull didn't work
              $DC up --build -d
            fi
      
            # Verify services are running
            echo "Checking running containers:"
            sleep 10
            $DC ps
      
            # Check container status
            echo "Container status:"
            $DC logs --tail=20
      
            # Verify port 80 is now serving your application
            echo "Testing port 80..."
            curl -f http://localhost:80 || echo "Port 80 test completed"
>>>>>>> 0d8d63c1dadf73962b28db510d70abafe28bfee1
